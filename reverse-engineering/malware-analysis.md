# Malware analysis

The goal of malware analysis and reverse engineering is to determine of a sample of code is malicious or not.

If the sample is determined to be safe the analysis stop here, the same goes if the sample have already been analysand, there probably exist a report of IOC or sigma rules set which will allow you to detect the sample.

![](https://lh3.googleusercontent.com/RsYYHZwVCyP9qFPknlJOc9H_wERPuLoBevXenqcUrV0cIEb6zVkpIBjhpP1Fy-dMvsY2X4qDOxF_JVZD_J4s7NyCzGRbQ4LDyXfIZh1g5L2a_32iwZR4MuobOZOy1A2cC7gpUYWo8kNtR306kA)

We will going more into depth on how to perform malware analysis.\
Starting with the simples to perform with sandbox and from there move toward more advance method of code-analysis.

It should be noted before you start any analysis. Start with looking up the hash of the sample.\
By using the *sha1sum* command on an file will return the sha1 hash of the file. This you can look up on sites such as VirusTotal. 

```
sha1sum sample
```

### Sandboxing 

The process of running the sample inside an virtual environment, hooking into the processes to detect the API it calls, the network calls it makes, etc. 
The one that is most often recommend is [cuckoo sandbox](https://cuckoosandbox.org) it an open source project, it allow you to throw any file at it, and after a period of time it will generate an report outlining the behavior for you.

Setting up Cuckoo can be bit of an hassle, I there for recommend one of two ways either install it using docker or find an virtual image where everything is setup for you.

# Static property analysis 

This is the analysis of malware without executing it.\
This is analysis of the file attributes such as hashed, code-signed, embedded strings, etc.\
if from these elements can not determine if the file is malicious or not, the next step dynamic analysis.


Code signing will indicate the author of the code, which allow one to determine if the bin is from a known source, and if it has been modified since last signed. 
This allows the analysis to quickly determine if the sample is begin or not simple by looking at the author of the file, looking of unsigned code or claims to be from a valid source

Strings - Allow one to extract strings from a complied binary, which can provide insight in to the capabilities of the sample, it will look for ASCII strings within sample.\
Information that can be gain by looking at strings within the sample are.\ 
* messages
* Method or function names
* configuration files
* urls
* API calls


# Dynamic
    
Active analysis of malware by executing the malware in a controlled environment with the purpose of monitoring of activity.\
Because we are working with live malware that can take control of the computer and spread itself to other systems.\
It is important the analysis the malware is done inside a contained environment.\
One way of doing this is using a virtual environment. Software such as VMware or VirtualBox, can help you virtualize computers.\
When it comes to virtual image. I find [remnux](https://remnux.org) to be very useful as it comes feature rich with malware analysis tools.\
**Remeber** to take snapshot of the image before execute the sample or you risk having to reinstall the environment. 

Because most malware is aimed at windows, it an good idea to have two virtual machines. Windows box where you can executed malware in and monitoring its behavior and an Linux box where you can control the network of the windows machine.\
Mirosoft provides virtual images for you to download for use for development.\
[Windows 10 image](https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/)

## Network

Many malware will try to perform an internet check to see if they are on a connected host, if they are unable to reach out they will self-destruct to stop malware analysis to look into the malware.

One way to set up an fake network is by either using [Fakenet-ng](https://github.com/mandiant/flare-fakenet-ng) or [INetSim](https://www.inetsim.org/). Both these solution will try to simulate an network for the malware to connect up to.

The way I set it up is by having all my windows network forwarded to the Linux box which is running INetSim for simulate the network and Wireshark for analysis the packets.



## Disassembling (code-analysis)

Binaries are written in programming language that is compiled into binary code that are interpreted at runtime into commands or code that the system understand.
when getting started with code-analysis a good starting point:
What API calls it makes
What are the arguments that are passed into these API calls
And if are any logic flow based upon the result of the calls

### Identifying interresting areas

Some techniques that have been developed as I reverse engineered software.

#### Utility functions

If there isn't an test after an call it most likely not of interest as the function called not does have an return value and most likely an utility function.

#### Decryption function

If the same function is called multiple times there high possibility it a decryption function

### Syscalls

Instead of using ntdll.dll to make syscalls, they are instead directly called by using the syscall ID of the call we want to execute.


# Unpackage malware

Unpack malware using memory hardware breakpoints
The first time the program touch the stack set an hardware breakpoint, it will break everytime it is accessed it.
    
XDbg ⇒ Right click on the memory ⇒ breakpoint ⇒ hardware access ⇒ Dword (32) Qwork (64) because it save a memory address

Then allow the program to run and it should stop when it touches the memory, each time it stop in the analyzed program check the for string references if there is no interesting continue the program checking everytime it stop for string references

XDbg 
- Plugins ⇒ OllyDebugEx ⇒ Get EIP as OEP ⇒ Fix Virtual offset ⇒ Dump Fix imports ⇒ scylla ⇒  IAT autosearch ⇒ Get imports ⇒ Fix Dump


# Analysis of scripts

Script are often obfuscated to make it more difficult to analysis the purpose of the script, the best to handle this is taking it slow and decode the script line by line.
Another solution is doing it dynamic and running the script with monitoring tools attached.

# Forensic Techniques

**Feature extraction**

The goal is feature extraction is to identify unique static metadata from files. tools such as Strings is very useful to get metadata about the file. Malware comes in many different formats.

**Office file**

Malware office files frequently comes in form of visual basic macro or excel 4.0 macro. extracting macros from office files with oledump to do static analyze without having to run the malware. Frequently the marco is obfuscated to make it hard to understand, using deobfuscation tools can help with this.

**Behavior extraction**

Behavior extraction is the method of executing the malware and analyzing how what it behavior it doing inside a sandbox.

#### Forensic procedures

**Executable Behavior extraction**

WIth the executable in hand, isolating it in a sandbox and executing it there and analyzing the log files of the system is a quick way to get an understanding of the procedure of the malware and what it does and in what order. An good example of this is doc files with embedded macros, taking it to a windows sandbox and executing it there to analyze what it does using Windows Sysmon

## **Obfuscation**

### **Ghost writing**

Ghost Writing is a way of Obfuscating the binary / assembly code in such a way that the signature no longer exists due to malware code obfuscation and no functionality of the malware is lost . The Idea here is to add random Assembly instructions to the disassembly of the executable and maintaining the functionality of the malware at the sametime. This is also called ghostwriting for antivirus An common way to do this is using Metasploit msfvenom to output the malware in raw binary. use ruby libery metasm (gem install metasm) to convert the binary to assembly code. edit the assembly to scramble the signature (common way is before a point get xor with it self, add some random code to the pointer ) convert the assembly code to executable and you have a scrambled malware.


## Tools

|Name|Description|link|
|---|---|---|
|PeStudio|||
|Strings|||
|CFF explorer|||
|peframe|||
|Detect it easy|||
|HxD|||
|Process hacker|||
|Process monitor|||
|Regshot|||
|Wireshark|||
|fakedns|||
|IDA||||
|Ghidra|||
|X64dbg|||
|Scylla|
|


## Self-defending 

As Malware author gets better. They are starting to introduce self-defending capabilities. Such as detecting virtualization, looking for analysis tool, etc.\
It the malware detect that it being analyzed it might terminate itself and in some cases it will even delete itself from the system.\
This will make it hard for us to perform analysis specially with sandbox and dynamic analysis. This quickly forces us to perform code-analysis of the sample.\

One way of dealing with this it to execute the sample attaches to an debugged an look for where in the code the sample tries to detect for analysis.\
And after patching the sample removing the capability of detecting analysis. 